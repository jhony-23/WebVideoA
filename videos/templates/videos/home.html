{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Reproductor de Medios - Carrusel</title>
    <link rel="stylesheet" href="{% static 'videos/css/home.css' %}">
</head>

<body>
    <!-- Botón Play centrado -->
    <div id="start-screen">
        <button id="play-button">PLAY</button>
    </div>

    <div class="media-title" id="media-title"></div>
    <div id="media-container">
        <!-- Agregamos un indicador de buffering -->
        <div id="buffer-indicator" style="display:none;">Cargando...</div>
        <video id="video-player" autoplay playsinline preload="auto" style="display:none;"></video>
        <img id="image-player" style="display:none;" alt="Media">
    </div>

    {{ media_items|json_script:"media-data" }}

    <!-- HLS.js para streaming adaptativo -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <script>
        const mediaList = JSON.parse(document.getElementById('media-data').textContent);
        const videoPlayer = document.getElementById('video-player');
        const imagePlayer = document.getElementById('image-player');
        const titleDiv = document.getElementById('media-title');
        const startScreen = document.getElementById('start-screen');
        const playButton = document.getElementById('play-button');
        const bufferIndicator = document.getElementById('buffer-indicator');

        // HLS instance
        let hls = null;

        let currentIndex = 0;
        let nextIndex = 1;
        let preloadedVideos = {};

        // Función para precargar el siguiente video
        function preloadNextVideo() {
            if (mediaList.length <= 1) return;

            nextIndex = (currentIndex + 1) % mediaList.length;
            const nextMedia = mediaList[nextIndex];

            // Solo precargar si es un video
            if (nextMedia.media_type === 'video' && !preloadedVideos[nextIndex]) {
                const preloadVideo = new Video();
                preloadVideo.src = nextMedia.file;
                preloadVideo.preload = 'auto';
                preloadVideo.load();
                preloadedVideos[nextIndex] = preloadVideo;
            }
        }

        // Función para reproducir fullscreen
        function requestFullScreen(element) {
            if (element.requestFullscreen) {
                element.requestFullscreen();
            } else if (element.webkitRequestFullscreen) {
                element.webkitRequestFullscreen();
            } else if (element.msRequestFullscreen) {
                element.msRequestFullscreen();
            }
        }

        // Función mejorada para reproducir media con mejor manejo de buffering
        function playMedia(index) {
            if (!mediaList.length) return;

            const media = mediaList[index];
            titleDiv.textContent = media.title;

            if (media.media_type === 'video') {
                imagePlayer.style.display = 'none';
                bufferIndicator.style.display = 'block';
                videoPlayer.style.display = 'block';

                // Destruir instancia HLS previa si existe
                if (hls) {
                    hls.destroy();
                    hls = null;
                }

                // Determinar URL (HLS o fallback)
                const videoUrl = media.stream_url || media.file;

                // Si es HLS y el navegador lo soporta
                if (videoUrl.endsWith('.m3u8') && Hls.isSupported()) {
                    hls = new Hls({
                        maxBufferLength: 30,          // Buffer máximo 30s
                        maxMaxBufferLength: 600,      // Límite absoluto 10min
                        maxBufferSize: 60 * 1000 * 1000,  // 60MB máximo en buffer
                        maxBufferHole: 0.5,           // Hueco máximo 0.5s
                        lowLatencyMode: false,        // Modo VOD
                        backBufferLength: 90,         // 90s de buffer hacia atrás
                        enableWorker: true,           // Web Worker para mejor performance
                        stretchShortVideoTrack: true, // Para videos cortos
                        startLevel: -1,               // Auto quality
                    });

                    hls.loadSource(videoUrl);
                    hls.attachMedia(videoPlayer);

                    // Eventos HLS
                    hls.on(Hls.Events.MANIFEST_PARSED, () => {
                        bufferIndicator.style.display = 'none';
                        videoPlayer.play();
                    });

                    hls.on(Hls.Events.ERROR, (event, data) => {
                        if (data.fatal) {
                            console.error('Error HLS:', data);
                            // Fallback a MP4 si falla HLS
                            videoPlayer.src = media.file;
                        }
                    });
                } else {
                    // Fallback para navegadores sin soporte HLS
                    videoPlayer.src = media.file;

                    // Iniciar la reproducción cuando hay suficiente buffer
                    videoPlayer.oncanplay = function () {
                        bufferIndicator.style.display = 'none';
                        videoPlayer.play();
                        // Precargar el siguiente video mientras se reproduce este
                        preloadNextVideo();
                    };

                    // Manejar eventos de buffering
                    videoPlayer.onwaiting = function () {
                        bufferIndicator.style.display = 'block';
                    };

                    videoPlayer.onplaying = function () {
                        bufferIndicator.style.display = 'none';
                    };

                    // Cargar el video
                    videoPlayer.load();
                }
            } else if (media.media_type === 'image') {
                // Limpiar HLS si existe
                if (hls) {
                    hls.destroy();
                    hls = null;
                }

                videoPlayer.pause();
                videoPlayer.style.display = 'none';
                bufferIndicator.style.display = 'none';
                imagePlayer.src = media.file;
                imagePlayer.style.display = 'block';

                // Avanza al siguiente media después de 10 segundos (actualizado de 5s)
                setTimeout(() => {
                    currentIndex = (currentIndex + 1) % mediaList.length;
                    playMedia(currentIndex);
                }, 10000);

                // Precargar el siguiente si es un video
                preloadNextVideo();
            }
        }

        videoPlayer.addEventListener('ended', () => {
            currentIndex = (currentIndex + 1) % mediaList.length;
            playMedia(currentIndex);
        });

        // Al presionar PLAY
        playButton.addEventListener('click', () => {
            startScreen.style.display = 'none'; // Oculta pantalla de inicio
            playMedia(currentIndex);
            requestFullScreen(document.documentElement); // fullscreen nativo
        });

        // Configurar video para mejor streaming
        videoPlayer.addEventListener('loadedmetadata', function () {
            // Si el navegador soporta buffering hints
            if ('buffered' in videoPlayer) {
                videoPlayer.autobuffer = true;
            }
        });

        // Manejar errores de video
        videoPlayer.addEventListener('error', function (e) {
            console.error('Error en reproducción de video:', videoPlayer.error);
            bufferIndicator.textContent = 'Error al cargar el video. Intentando siguiente...';
            setTimeout(() => {
                currentIndex = (currentIndex + 1) % mediaList.length;
                playMedia(currentIndex);
            }, 3000);
        });
    </script>
</body>

</html>