{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Reproductor de Medios - Carrusel</title>
    <link rel="stylesheet" href="{% static 'videos/css/home.css' %}">
</head>

<body>
    <!-- Botón Play centrado -->
    <div id="start-screen">
        <button id="play-button">PLAY</button>
    </div>

    <div class="media-title" id="media-title"></div>
    <div id="status-banner"
        style="display:none; font-size:14px; color:#fff; background:#333; padding:4px 8px; margin:4px 0; border-radius:4px;">
    </div>
    <div id="media-container">
        <!-- Agregamos un indicador de buffering -->
        <div id="buffer-indicator" style="display:none;">Cargando...</div>
        <video id="video-player" autoplay playsinline preload="auto" style="display:none;"></video>
        <img id="image-player" style="display:none;" alt="Media">
    </div>

    {{ media_items|json_script:"media-data" }}

    <!-- HLS.js para streaming adaptativo -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <script>
        const mediaList = JSON.parse(document.getElementById('media-data').textContent);
        const videoPlayer = document.getElementById('video-player');
        const imagePlayer = document.getElementById('image-player');
        const titleDiv = document.getElementById('media-title');
        const startScreen = document.getElementById('start-screen');
        const playButton = document.getElementById('play-button');
        const bufferIndicator = document.getElementById('buffer-indicator');

        // HLS instance
        let hls = null;
        const pollIntervals = {}; // media_id -> interval id

        function setStatus(text, type = 'info') {
            const banner = document.getElementById('status-banner');
            banner.style.display = 'block';
            const colors = { info: '#333', ready: '#2d6a4f', error: '#8b0000', waiting: '#6c5d1a' };
            banner.style.background = colors[type] || '#333';
            banner.textContent = text;
        }

        function clearStatus() {
            const banner = document.getElementById('status-banner');
            banner.style.display = 'none';
        }

        async function pollStreamReady(media) {
            // Evitar doble polling
            if (pollIntervals[media.id]) return;
            setStatus('Procesando HLS para ' + media.title + '...', 'waiting');
            pollIntervals[media.id] = setInterval(async () => {
                try {
                    const resp = await fetch(`/status/${media.id}/`);
                    if (!resp.ok) return;
                    const data = await resp.json();
                    if (data.is_stream_ready || data.stream_status === 'ready') {
                        clearInterval(pollIntervals[media.id]);
                        delete pollIntervals[media.id];
                        media.stream_url = data.stream_url;
                        media.is_stream_ready = true;
                        setStatus('Listo: ' + media.title + ' (HLS)', 'ready');
                        if (currentIndex !== undefined && mediaList[currentIndex].id === media.id) {
                            // Reproducir nuevamente usando HLS sin cambiar el orden
                            startHlsPlayback(media);
                        }
                    } else if (data.stream_status === 'failed') {
                        clearInterval(pollIntervals[media.id]);
                        delete pollIntervals[media.id];
                        setStatus('Error procesando ' + media.title, 'error');
                    }
                } catch (e) {
                    console.warn('Polling error', e);
                }
            }, 5000);
        }

        let currentIndex = 0;
        let nextIndex = 1;
        let preloadedVideos = {};

        // Función para precargar el siguiente video
        function preloadNextVideo() {
            if (mediaList.length <= 1) return;

            nextIndex = (currentIndex + 1) % mediaList.length;
            const nextMedia = mediaList[nextIndex];

            // Solo precargar si es un video
            if (nextMedia.media_type === 'video' && !preloadedVideos[nextIndex]) {
                const preloadVideo = document.createElement('video');
                preloadVideo.src = nextMedia.file;
                preloadVideo.preload = 'auto';
                preloadVideo.load();
                preloadedVideos[nextIndex] = preloadVideo;
            }
        }

        // Función para reproducir fullscreen
        function requestFullScreen(element) {
            if (element.requestFullscreen) {
                element.requestFullscreen();
            } else if (element.webkitRequestFullscreen) {
                element.webkitRequestFullscreen();
            } else if (element.msRequestFullscreen) {
                element.msRequestFullscreen();
            }
        }

        // Función mejorada para reproducir media con mejor manejo de buffering
        function playMedia(index) {
            if (!mediaList.length) return;

            const media = mediaList[index];
            titleDiv.textContent = media.title;

            if (media.media_type === 'video') {
                imagePlayer.style.display = 'none';
                bufferIndicator.style.display = 'block';
                videoPlayer.style.display = 'block';

                // Destruir instancia HLS previa si existe
                if (hls) {
                    hls.destroy();
                    hls = null;
                }

                // Determinar URL (HLS o fallback)
                const videoUrl = media.stream_url || media.file;

                // Si aún no está listo el HLS pero hay procesamiento pendiente -> iniciar polling
                if (!media.is_stream_ready && media.stream_status && media.stream_status !== 'failed') {
                    pollStreamReady(media);
                }

                // Si es HLS y el navegador lo soporta
                if (videoUrl.endsWith('.m3u8') && Hls.isSupported()) {
                    startHlsPlayback(media, videoUrl);
                } else {
                    startTagPlayback(media);
                }
            } else if (media.media_type === 'image') {
                // ... existing image logic remains below (unchanged) ...
                if (hls) { hls.destroy(); hls = null; }
                videoPlayer.pause();
                videoPlayer.style.display = 'none';
                bufferIndicator.style.display = 'none';
                imagePlayer.src = media.file;
                imagePlayer.style.display = 'block';
                setTimeout(() => {
                    currentIndex = (currentIndex + 1) % mediaList.length;
                    playMedia(currentIndex);
                }, 10000);
                preloadNextVideo();
            }
        }

        function startHlsPlayback(media, urlOverride) {
            const videoUrl = urlOverride || media.stream_url || media.file;
            hls = new Hls({
                maxBufferLength: 10,          // Buffer de 10s (más eficiente)
                maxMaxBufferLength: 30,       // Máximo 30s de buffer
                maxBufferSize: 30 * 1000 * 1000,  // 30MB máximo en buffer
                enableWorker: true,           // Usar Web Worker para mejor rendimiento
                lowLatencyMode: false,        // Modo VOD para streaming estable
                backBufferLength: 90,         // 90s de buffer hacia atrás
                startLevel: -1,               // Auto-seleccionar calidad inicial
                abrEwmaDefaultEstimate: 500000, // 500kbps estimado inicial
                abrBandWidthFactor: 0.95,      // Factor conservador para cambios de calidad
                abrBandWidthUpFactor: 0.7,     // Más conservador al subir calidad
                fragLoadingTimeOut: 20000,      // 20s timeout para segmentos
                manifestLoadingTimeOut: 10000,  // 10s timeout para manifests
                maxBufferHole: 0.5,           // Hueco máximo 0.5s
                stretchShortVideoTrack: true, // Para videos cortos
            });

            hls.loadSource(videoUrl);
            hls.attachMedia(videoPlayer);
            hls.on(Hls.Events.MANIFEST_PARSED, () => {
                bufferIndicator.style.display = 'none';
                videoPlayer.play();
                preloadNextVideo();
            });
            hls.on(Hls.Events.ERROR, (event, data) => {
                if (data.fatal) {
                    console.error('Error HLS:', data);
                    setStatus('Fallo HLS, usando MP4', 'error');
                    if (hls) { hls.destroy(); hls = null; }
                    startTagPlayback(media);
                }
            });
        }

        function startTagPlayback(media) {
            videoPlayer.src = media.file;
            videoPlayer.oncanplay = function () {
                bufferIndicator.style.display = 'none';
                videoPlayer.play();
                preloadNextVideo();
            };
            videoPlayer.onwaiting = function () { bufferIndicator.style.display = 'block'; };
            videoPlayer.onplaying = function () { bufferIndicator.style.display = 'none'; };
            videoPlayer.load();
        }

        videoPlayer.addEventListener('ended', () => {
            currentIndex = (currentIndex + 1) % mediaList.length;
            playMedia(currentIndex);
        });

        // Al presionar PLAY
        playButton.addEventListener('click', () => {
            startScreen.style.display = 'none'; // Oculta pantalla de inicio
            playMedia(currentIndex);
            requestFullScreen(document.documentElement); // fullscreen nativo
        });

        // Configurar video para mejor streaming
        videoPlayer.addEventListener('loadedmetadata', function () {
            // Si el navegador soporta buffering hints
            if ('buffered' in videoPlayer) {
                videoPlayer.autobuffer = true;
            }
        });

        // Manejar errores de video
        videoPlayer.addEventListener('error', function (e) {
            console.error('Error en reproducción de video:', videoPlayer.error);
            bufferIndicator.textContent = 'Error al cargar el video. Intentando siguiente...';
            setTimeout(() => {
                currentIndex = (currentIndex + 1) % mediaList.length;
                playMedia(currentIndex);
            }, 3000);
        });
    </script>
</body>

</html>