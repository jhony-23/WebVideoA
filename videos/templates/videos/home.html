{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Reproductor de Medios - Carrusel</title>
    <link rel="icon" type="image/png" href="{% static 'videos/img/favicon_institucion.png' %}?v=5">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="{% static 'videos/css/home.css' %}">
</head>

<body>
    <!-- Bot√≥n Play centrado -->
    <div id="start-screen">
        <button id="play-button">PLAY</button>
    </div>

    <div class="media-title" id="media-title"></div>
    <div id="status-banner"
        style="display:none; font-size:14px; color:#fff; background:#333; padding:4px 8px; margin:4px 0; border-radius:4px;">
    </div>
    <div id="media-container">
        <!-- Agregamos un indicador de buffering -->
        <div id="buffer-indicator" style="display:none;">Cargando...</div>
        <video id="video-player" autoplay playsinline preload="auto" style="display:none;"></video>
        <img id="image-player" style="display:none;" alt="Media">
    </div>

    <!-- HLS.js para streaming adaptativo -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <script>
        // =============== SISTEMA SINCRONIZADO LIVE ===============
        const videoPlayer = document.getElementById('video-player');
        const imagePlayer = document.getElementById('image-player');
        const titleDiv = document.getElementById('media-title');
        const startScreen = document.getElementById('start-screen');
        const playButton = document.getElementById('play-button');
        const bufferIndicator = document.getElementById('buffer-indicator');

        // Estado de sincronizaci√≥n
        let hls = null;
        let syncInterval = null;
        let currentMediaData = null;
        let isPlaying = false;

        function setStatus(text, type = 'info') {
            const banner = document.getElementById('status-banner');
            banner.style.display = 'block';
            const colors = { 
                info: '#333', 
                live: '#dc3545',  // Rojo para LIVE
                ready: '#2d6a4f', 
                error: '#8b0000', 
                waiting: '#6c5d1a' 
            };
            banner.style.background = colors[type] || '#333';
            banner.textContent = text;
        }

        function clearStatus() {
            const banner = document.getElementById('status-banner');
            banner.style.display = 'none';
        }

        async function checkSyncStatus() {
            try {
                const response = await fetch('/api/sync/');
                const data = await response.json();
                
                if (!data.active) {
                    // No hay reproducci√≥n activa
                    setStatus('‚è∏Ô∏è Sin transmisi√≥n activa', 'waiting');
                    stopCurrentMedia();
                    return;
                }

                // Hay contenido activo
                const media = data.current_media;
                const elapsed = data.elapsed;
                const duration = data.duration;

                // Mostrar estado LIVE
                setStatus(`üî¥ LIVE - ${media.title} (${data.current_index + 1}/${data.total_items})`, 'live');
                titleDiv.textContent = media.title;

                // Si es diferente media, cambiar
                if (!currentMediaData || currentMediaData.id !== media.id) {
                    currentMediaData = media;
                    playCurrentMedia(media, elapsed);
                }

            } catch (error) {
                console.warn('Error sync:', error);
                setStatus('‚ùå Error de conexi√≥n', 'error');
            }
        }

        function playCurrentMedia(media, startFrom = 0) {
            stopCurrentMedia();
            
            if (media.media_type === 'video') {
                playVideo(media, startFrom);
            } else if (media.media_type === 'image') {
                playImage(media, startFrom);
            }
        }

        function playVideo(media, startFrom = 0) {
            imagePlayer.style.display = 'none';
            bufferIndicator.style.display = 'block';
            videoPlayer.style.display = 'block';

            const videoUrl = media.stream_url || media.file;

            // Si es HLS
            if (videoUrl.endsWith('.m3u8') && Hls.isSupported()) {
                hls = new Hls({
                    maxBufferLength: 10,
                    maxMaxBufferLength: 30,
                    maxBufferSize: 30 * 1000 * 1000,
                    enableWorker: true,
                    lowLatencyMode: false,
                    backBufferLength: 60,
                    startLevel: -1,
                    abrEwmaDefaultEstimate: 500000,
                    abrBandWidthFactor: 0.95,
                    abrBandWidthUpFactor: 0.7,
                    fragLoadingTimeOut: 15000,
                    manifestLoadingTimeOut: 8000,
                    maxBufferHole: 0.5
                });

                hls.loadSource(videoUrl);
                hls.attachMedia(videoPlayer);
                
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    bufferIndicator.style.display = 'none';
                    videoPlayer.currentTime = startFrom;
                    videoPlayer.play().catch(console.warn);
                });
                
                hls.on(Hls.Events.ERROR, (event, data) => {
                    if (data.fatal) {
                        console.error('HLS Error:', data);
                        // Fallback a MP4
                        if (hls) { hls.destroy(); hls = null; }
                        playVideoTag(media, startFrom);
                    }
                });
            } else {
                // Reproducci√≥n directa MP4
                playVideoTag(media, startFrom);
            }
        }

        function playVideoTag(media, startFrom = 0) {
            videoPlayer.src = media.file;
            videoPlayer.oncanplay = function () {
                bufferIndicator.style.display = 'none';
                videoPlayer.currentTime = startFrom;
                videoPlayer.play().catch(console.warn);
            };
            videoPlayer.onwaiting = function () { bufferIndicator.style.display = 'block'; };
            videoPlayer.onplaying = function () { bufferIndicator.style.display = 'none'; };
            videoPlayer.load();
        }

        function playImage(media, startFrom = 0) {
            if (hls) { hls.destroy(); hls = null; }
            videoPlayer.style.display = 'none';
            bufferIndicator.style.display = 'none';
            imagePlayer.src = media.file;
            imagePlayer.style.display = 'block';
        }

        function stopCurrentMedia() {
            if (hls) {
                hls.destroy();
                hls = null;
            }
            videoPlayer.pause();
            videoPlayer.src = '';
            videoPlayer.style.display = 'none';
            imagePlayer.style.display = 'none';
            bufferIndicator.style.display = 'none';
        }

        function requestFullScreen(element) {
            if (element.requestFullscreen) {
                element.requestFullscreen();
            } else if (element.webkitRequestFullscreen) {
                element.webkitRequestFullscreen();
            } else if (element.msRequestFullscreen) {
                element.msRequestFullscreen();
            }
        }

        // Iniciar sincronizaci√≥n cuando presionen PLAY
        playButton.addEventListener('click', () => {
            startScreen.style.display = 'none';
            isPlaying = true;
            
            // Iniciar polling cada 3 segundos
            syncInterval = setInterval(checkSyncStatus, 3000);
            
            // Primera verificaci√≥n inmediata
            checkSyncStatus();
            
            // Pantalla completa
            requestFullScreen(document.documentElement);
        });

        // Manejar errores de video
        videoPlayer.addEventListener('error', function (e) {
            console.error('Error en video:', videoPlayer.error);
            setStatus('‚ùå Error cargando video', 'error');
        });
    </script>
</body>

</html>