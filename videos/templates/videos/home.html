{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Reproductor de Medios - Carrusel</title>
    <link rel="icon" type="image/png" href="{% static 'videos/img/favicon_institucion.png' %}?v=5">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="{% static 'videos/css/home.css' %}?v=2.0">
</head>

<body>
    <!-- Bot√≥n Play centrado -->
    <div id="start-screen">
        <button id="play-button">PLAY</button>
    </div>

    <div class="media-title" id="media-title"></div>
    <div id="status-banner"
        style="display:none; font-size:14px; color:#fff; background:#333; padding:4px 8px; margin:4px 0; border-radius:4px;">
    </div>
    <div id="media-container">
        <!-- Agregamos un indicador de buffering -->
        <div id="buffer-indicator" style="display:none;">Cargando...</div>
        <video id="video-player" autoplay playsinline preload="auto" style="display:none;"></video>
        <img id="image-player" style="display:none;" alt="Media">
    </div>

    <!-- HLS.js para streaming adaptativo -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <script>
        // =============== SISTEMA SINCRONIZADO LIVE ===============
        const videoPlayer = document.getElementById('video-player');
        const imagePlayer = document.getElementById('image-player');
        const titleDiv = document.getElementById('media-title');
        const startScreen = document.getElementById('start-screen');
        const playButton = document.getElementById('play-button');
        const bufferIndicator = document.getElementById('buffer-indicator');

        // Estado de sincronizaci√≥n
        let hls = null;
        let syncInterval = null;
        let currentMediaData = null;
        let isPlaying = false;

        function setStatus(text, type = 'info') {
            const banner = document.getElementById('status-banner');
            banner.style.display = 'block';
            const colors = { 
                info: '#333', 
                live: '#dc3545',  // Rojo para LIVE
                ready: '#2d6a4f', 
                error: '#8b0000', 
                waiting: '#6c5d1a' 
            };
            banner.style.background = colors[type] || '#333';
            banner.textContent = text;
        }

        function clearStatus() {
            const banner = document.getElementById('status-banner');
            banner.style.display = 'none';
        }

        async function checkSyncStatus() {
            try {
                const response = await fetch('/api/sync/');
                const data = await response.json();
                
                if (!data.active) {
                    // No hay reproducci√≥n activa
                    setStatus('‚è∏Ô∏è Sin transmisi√≥n activa', 'waiting');
                    stopCurrentMedia();
                    return;
                }

                // Hay contenido activo
                const media = data.current_media;
                const elapsed = data.elapsed;
                const duration = data.duration;
                
                // Debug: mostrar datos recibidos
                console.log('Datos recibidos:', {
                    media: media,
                    elapsed: elapsed,
                    duration: duration,
                    index: data.current_index,
                    total: data.total_items
                });

                // Mostrar estado LIVE
                setStatus(`üî¥ LIVE - ${media.title} (${data.current_index + 1}/${data.total_items})`, 'live');
                titleDiv.textContent = media.title;

                // Si es diferente media, cambiar
                if (!currentMediaData || currentMediaData.id !== media.id) {
                    currentMediaData = media;
                    playCurrentMedia(media, elapsed);
                }

            } catch (error) {
                console.warn('Error sync:', error);
                setStatus('‚ùå Error de conexi√≥n', 'error');
            }
        }

        function playCurrentMedia(media, startFrom = 0) {
            stopCurrentMedia();
            
            // Detectar si es vertical (height > width)
            const isVertical = media.height && media.width && media.height > media.width;
            console.log(`üé¨ DUPLICADO CHECK: Media "${media.title}": ${media.width}x${media.height}, Vertical: ${isVertical}`);
            
            // Debug visual en el banner
            if (isVertical) {
                setStatus(`üîÑ DUPLICANDO: ${media.title} (${media.width}x${media.height})`, 'info');
            }
            
            if (isVertical) {
                // Duplicar medios verticales
                if (media.media_type === 'video') {
                    playDuplicateVideo(media, startFrom);
                } else if (media.media_type === 'image') {
                    playDuplicateImage(media, startFrom);
                }
            } else {
                // Medios horizontales normales
                if (media.media_type === 'video') {
                    playVideo(media, startFrom);
                } else if (media.media_type === 'image') {
                    playImage(media, startFrom);
                }
            }
        }

        function playVideo(media, startFrom = 0) {
            imagePlayer.style.display = 'none';
            bufferIndicator.style.display = 'block';
            videoPlayer.style.display = 'block';

            const videoUrl = media.stream_url || media.file_url || media.file;

            // Si es HLS
            if (videoUrl.endsWith('.m3u8') && Hls.isSupported()) {
                hls = new Hls({
                    maxBufferLength: 10,
                    maxMaxBufferLength: 30,
                    maxBufferSize: 30 * 1000 * 1000,
                    enableWorker: true,
                    lowLatencyMode: false,
                    backBufferLength: 60,
                    startLevel: -1,
                    abrEwmaDefaultEstimate: 500000,
                    abrBandWidthFactor: 0.95,
                    abrBandWidthUpFactor: 0.7,
                    fragLoadingTimeOut: 15000,
                    manifestLoadingTimeOut: 8000,
                    maxBufferHole: 0.5
                });

                hls.loadSource(videoUrl);
                hls.attachMedia(videoPlayer);
                
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    bufferIndicator.style.display = 'none';
                    videoPlayer.currentTime = startFrom;
                    videoPlayer.play().catch(console.warn);
                });
                
                hls.on(Hls.Events.ERROR, (event, data) => {
                    if (data.fatal) {
                        console.error('HLS Error:', data);
                        // Fallback a MP4
                        if (hls) { hls.destroy(); hls = null; }
                        playVideoTag(media, startFrom);
                    }
                });
            } else {
                // Reproducci√≥n directa MP4
                playVideoTag(media, startFrom);
            }
        }

        function playVideoTag(media, startFrom = 0) {
            const videoUrl = media.file_url || media.stream_url || media.file;
            videoPlayer.src = videoUrl;
            videoPlayer.oncanplay = function () {
                bufferIndicator.style.display = 'none';
                videoPlayer.currentTime = startFrom;
                videoPlayer.play().catch(console.warn);
            };
            videoPlayer.onwaiting = function () { bufferIndicator.style.display = 'block'; };
            videoPlayer.onplaying = function () { bufferIndicator.style.display = 'none'; };
            videoPlayer.load();
        }

        function playImage(media, startFrom = 0) {
            if (hls) { hls.destroy(); hls = null; }
            videoPlayer.style.display = 'none';
            bufferIndicator.style.display = 'none';
            
            // Usar la URL correcta para im√°genes
            const imageUrl = media.file_url || media.stream_url || media.file;
            console.log('Cargando imagen:', imageUrl); // Debug
            
            imagePlayer.src = imageUrl;
            imagePlayer.style.display = 'block';
            
            // Manejar errores de carga de imagen
            imagePlayer.onerror = function() {
                console.error('Error cargando imagen:', imageUrl);
                setStatus('‚ùå Error cargando imagen', 'error');
            };
            
            imagePlayer.onload = function() {
                console.log('Imagen cargada correctamente:', imageUrl);
            };
        }

        function playDuplicateVideo(media, startFrom = 0) {
            // Ocultar reproductores normales
            imagePlayer.style.display = 'none';
            videoPlayer.style.display = 'none';
            bufferIndicator.style.display = 'block';
            
            // Crear contenedor duplicado
            const container = createDuplicateContainer();
            const videoUrl = media.stream_url || media.file_url || media.file;
            
            // Crear dos videos id√©nticos
            const video1 = document.createElement('video');
            const video2 = document.createElement('video');
            
            [video1, video2].forEach(video => {
                video.className = 'media-duplicate';
                video.autoplay = true;
                video.playsinline = true;
                video.preload = 'auto';
                video.muted = true; // Evitar problemas de autoplay
                container.appendChild(video);
            });
            
            // Si es HLS y est√° soportado
            if (videoUrl.endsWith('.m3u8') && Hls.isSupported()) {
                setupDuplicateHLS(video1, video2, videoUrl, startFrom);
            } else {
                setupDuplicateVideo(video1, video2, videoUrl, startFrom);
            }
        }
        
        function playDuplicateImage(media, startFrom = 0) {
            // Ocultar reproductores normales
            if (hls) { hls.destroy(); hls = null; }
            videoPlayer.style.display = 'none';
            imagePlayer.style.display = 'none';
            bufferIndicator.style.display = 'none';
            
            // Crear contenedor duplicado
            const container = createDuplicateContainer();
            const imageUrl = media.file_url || media.stream_url || media.file;
            
            // Crear dos im√°genes id√©nticas
            const img1 = document.createElement('img');
            const img2 = document.createElement('img');
            
            [img1, img2].forEach(img => {
                img.className = 'media-duplicate';
                img.src = imageUrl;
                img.alt = media.title;
                container.appendChild(img);
                
                img.onerror = function() {
                    console.error('Error cargando imagen duplicada:', imageUrl);
                    setStatus('‚ùå Error cargando imagen', 'error');
                };
                
                img.onload = function() {
                    console.log('Imagen duplicada cargada correctamente:', imageUrl);
                };
            });
        }
        
        function createDuplicateContainer() {
            // Remover contenedor duplicado existente si existe
            const existing = document.querySelector('.media-duplicate-container');
            if (existing) {
                existing.remove();
            }
            
            // Crear nuevo contenedor
            const container = document.createElement('div');
            container.className = 'media-duplicate-container';
            document.getElementById('media-container').appendChild(container);
            
            return container;
        }
        
        function setupDuplicateHLS(video1, video2, videoUrl, startFrom) {
            let hls1, hls2;
            let loadedCount = 0;
            
            const onManifestParsed = () => {
                loadedCount++;
                if (loadedCount === 2) {
                    bufferIndicator.style.display = 'none';
                    video1.currentTime = startFrom;
                    video2.currentTime = startFrom;
                    video1.play().catch(console.warn);
                    video2.play().catch(console.warn);
                }
            };
            
            // Configurar HLS para video1
            hls1 = new Hls();
            hls1.loadSource(videoUrl);
            hls1.attachMedia(video1);
            hls1.on(Hls.Events.MANIFEST_PARSED, onManifestParsed);
            
            // Configurar HLS para video2  
            hls2 = new Hls();
            hls2.loadSource(videoUrl);
            hls2.attachMedia(video2);
            hls2.on(Hls.Events.MANIFEST_PARSED, onManifestParsed);
            
            // Guardar referencias para limpiar despu√©s
            window.duplicateHls1 = hls1;
            window.duplicateHls2 = hls2;
        }
        
        function setupDuplicateVideo(video1, video2, videoUrl, startFrom) {
            let loadedCount = 0;
            
            const onCanPlay = () => {
                loadedCount++;
                if (loadedCount === 2) {
                    bufferIndicator.style.display = 'none';
                    video1.currentTime = startFrom;
                    video2.currentTime = startFrom;
                    video1.play().catch(console.warn);
                    video2.play().catch(console.warn);
                }
            };
            
            video1.src = videoUrl;
            video2.src = videoUrl;
            
            video1.oncanplay = onCanPlay;
            video2.oncanplay = onCanPlay;
            
            video1.load();
            video2.load();
        }

        function stopCurrentMedia() {
            // Limpiar HLS normal
            if (hls) {
                hls.destroy();
                hls = null;
            }
            
            // Limpiar HLS duplicados
            if (window.duplicateHls1) {
                window.duplicateHls1.destroy();
                window.duplicateHls1 = null;
            }
            if (window.duplicateHls2) {
                window.duplicateHls2.destroy();
                window.duplicateHls2 = null;
            }
            
            // Limpiar reproductores normales
            videoPlayer.pause();
            videoPlayer.src = '';
            videoPlayer.style.display = 'none';
            imagePlayer.style.display = 'none';
            bufferIndicator.style.display = 'none';
            
            // Remover contenedor duplicado
            const duplicateContainer = document.querySelector('.media-duplicate-container');
            if (duplicateContainer) {
                duplicateContainer.remove();
            }
        }

        function requestFullScreen(element) {
            if (element.requestFullscreen) {
                element.requestFullscreen();
            } else if (element.webkitRequestFullscreen) {
                element.webkitRequestFullscreen();
            } else if (element.msRequestFullscreen) {
                element.msRequestFullscreen();
            }
        }

        // Iniciar sincronizaci√≥n cuando presionen PLAY
        playButton.addEventListener('click', () => {
            startScreen.style.display = 'none';
            isPlaying = true;
            
            // Iniciar polling cada 3 segundos
            syncInterval = setInterval(checkSyncStatus, 3000);
            
            // Primera verificaci√≥n inmediata
            checkSyncStatus();
            
            // Pantalla completa
            requestFullScreen(document.documentElement);
        });

        // Manejar errores de video
        videoPlayer.addEventListener('error', function (e) {
            console.error('Error en video:', videoPlayer.error);
            setStatus('‚ùå Error cargando video', 'error');
        });
    </script>
</body>

</html>