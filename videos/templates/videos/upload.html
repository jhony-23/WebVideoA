{% load widget_tweaks %}
{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Panel de Mercadotecnia</title>
    <link rel="icon" type="image/svg+xml" href="{% static 'videos/img/favicon_institucion.svg' %}?v=3">
    <link rel="icon" type="image/x-icon" href="{% static 'videos/img/favicon.ico' %}?v=3">
    <link rel="stylesheet" href="{% static 'videos/css/upload.css' %}">
</head>

<body>
    <header>
        <h1>Panel de Mercadotecnia ADICLA</h1>
    </header>

    <main>
        <!-- FORMULARIO -->
        <section class="form-section">
            <h2>Subir Contenido</h2>
            <form method="post" enctype="multipart/form-data" class="upload-form">
                {% csrf_token %}

                <!-- Campo para el t√≠tulo -->
                <div>
                    {{ form.title.label_tag }}
                    {{ form.title }}
                </div>

                <!-- Campo tipo de media -->
                <div>
                    {{ form.media_type.label_tag }}
                    {{ form.media_type }}
                </div>

                <!-- Campo de archivo personalizado -->
                <label class="upload-label" for="id_file">
                    Seleccionar archivo
                </label>
                <input type="file" id="id_file" name="{{ form.file.name }}" class="custom-file-input">




                <!-- Previsualizaci√≥n -->
                <div id="preview-container" style="margin-top:10px;">
                    <video id="video-preview" style="display:none;" controls width="300"></video>
                    <img id="image-preview" style="display:none;" width="300">
                </div>
                <div style="text-align: center;">
                    <button type="submit" class="btn btn-upload" style="padding: 16px 32px; font-size: 1.2em;">üì§
                        Subir Contenido</button>
                </div>
            </form>
        </section>

        <!-- PANEL DE CONTROL DE REPRODUCCI√ìN -->
        <section class="form-section">
            <h2>Control de Reproducci√≥n</h2>
            <div style="text-align: center; padding: 20px;">
                
                <!-- Estado actual -->
                <div id="playlist-status" style="margin-bottom: 20px;">
                    {% if playlist_state.is_active %}
                        <div style="color: #28a745; font-weight: bold; font-size: 18px; margin-bottom: 10px;">
                            üü¢ REPRODUCCI√ìN ACTIVA
                        </div>
                        <p style="color: #666;">Todas las pantallas pueden ver el contenido sincronizado</p>
                    {% else %}
                        <div style="color: #dc3545; font-weight: bold; font-size: 18px; margin-bottom: 10px;">
                            üî¥ REPRODUCCI√ìN DETENIDA
                        </div>
                        <p style="color: #666;">Presiona "Iniciar" para comenzar la transmisi√≥n</p>
                    {% endif %}
                </div>

                <!-- Botones de control -->
                <div style="margin-bottom: 15px;">
                    {% if playlist_state.is_active %}
                        <button id="stop-btn" class="btn" style="background-color: #dc3545; color: white; padding: 15px 30px; font-size: 1.1em; border: none; border-radius: 5px; cursor: pointer;">
                            ‚èπÔ∏è DETENER REPRODUCCI√ìN
                        </button>
                    {% else %}
                        <button id="start-btn" class="btn" style="background-color: #28a745; color: white; padding: 15px 30px; font-size: 1.1em; border: none; border-radius: 5px; cursor: pointer;">
                            ‚ñ∂Ô∏è INICIAR REPRODUCCI√ìN
                        </button>
                    {% endif %}
                </div>
                
                <!-- Link al reproductor -->
                <div>
                    <a href="/" target="_blank" style="color: #007bff; text-decoration: none; font-weight: bold;">
                        üì∫ Ver Reproducci√≥n Actual
                    </a>
                </div>
                
                <!-- Logout -->
                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
                    <a href="{% url 'logout' %}" style="color: #6c757d; text-decoration: none; font-size: 14px;">
                        üö™ Cerrar Sesi√≥n
                    </a>
                </div>
                
            </div>
        </section>

        <!-- LISTA DE VIDEOS/IM√ÅGENES -->
        <section class="videos-section">
            <h2>Contenido Subido</h2>
            <div class="video-grid">
                {% for media in media_items %}
                <div class="video-card">
                    <div class="video-info">
                        <h3>{{ media.title }}</h3>
                        <p class="date">{{ media.uploaded_at|date:"d M Y H:i" }}</p>
                    </div>

                    <!-- Miniatura / Reproductor -->
                    <div class="video-preview">
                        {% if media.media_type == "video" %}
                        <video width="300" controls>
                            <source src="{{ media.file.url }}" type="video/mp4">
                            Tu navegador no soporta videos.
                        </video>
                        {% elif media.media_type == "image" %}
                        <img src="{{ media.file.url }}" alt="{{ media.title }}" width="300">
                        {% endif %}
                    </div>

                    <div class="video-actions">
                        <button type="button" class="btn btn-delete" data-video-id="{{ media.id }}"
                            data-video-title="{{ media.title }}">üóëÔ∏è Eliminar</button>
                    </div>
                </div>
                {% empty %}
                <p>No hay archivos multimedia subidos</p>
                {% endfor %}

            </div>
        </section>
    </main>

    <!-- Modal de confirmaci√≥n -->
    <div class="modal" id="confirmModal">
        <div class="modal-content">
            <h2>Confirmar eliminaci√≥n</h2>
            <p id="modal-text"></p>
            <div class="modal-actions">
                <form id="deleteForm" method="post" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-delete">‚úÖ S√≠, eliminar</button>
                </form>
                <button type="button" class="btn btn-cancel" id="cancelDelete">‚ùå Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // Previsualizaci√≥n antes de subir
        const fileInput = document.getElementById("id_file");
        const videoPreview = document.getElementById("video-preview");
        const imagePreview = document.getElementById("image-preview");

        fileInput.addEventListener("change", () => {
            const file = fileInput.files[0];
            if (!file) return;

            const fileURL = URL.createObjectURL(file);
            if (file.type.startsWith("video/")) {
                imagePreview.style.display = "none";
                videoPreview.src = fileURL;
                videoPreview.style.display = "block";
            } else if (file.type.startsWith("image/")) {
                videoPreview.style.display = "none";
                imagePreview.src = fileURL;
                imagePreview.style.display = "block";
            }
        });

        // Modal de eliminaci√≥n
        document.addEventListener('DOMContentLoaded', function () {
            const modal = document.getElementById("confirmModal");
            const modalText = document.getElementById("modal-text");
            const cancelBtn = document.getElementById("cancelDelete");
            const deleteForm = document.getElementById("deleteForm");

            const deleteButtons = document.querySelectorAll(".btn-delete[data-video-id]");
            deleteButtons.forEach(btn => {
                btn.addEventListener("click", function () {
                    const mediaId = this.dataset.videoId;
                    const mediaTitle = this.dataset.videoTitle;

                    modalText.textContent = `¬øSeguro que quieres eliminar "${mediaTitle}"?`;
                    deleteForm.action = `/delete/${mediaId}/`;
                    modal.style.display = "flex";
                });
            });

            cancelBtn.addEventListener("click", function () {
                modal.style.display = "none";
            });
        });

        // Control de playlist
        document.addEventListener('DOMContentLoaded', function () {
            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');

            if (startBtn) {
                startBtn.addEventListener('click', async function() {
                    this.disabled = true;
                    this.textContent = '‚è≥ Iniciando...';
                    
                    try {
                        const response = await fetch('/api/playlist/start/', {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        const data = await response.json();
                        if (data.success) {
                            // Redirigir al reproductor
                            window.location.href = data.redirect;
                        } else {
                            alert('Error: ' + (data.error || 'No se pudo iniciar la reproducci√≥n'));
                            this.disabled = false;
                            this.textContent = '‚ñ∂Ô∏è INICIAR REPRODUCCI√ìN';
                        }
                    } catch (error) {
                        alert('Error de conexi√≥n');
                        this.disabled = false;
                        this.textContent = '‚ñ∂Ô∏è INICIAR REPRODUCCI√ìN';
                    }
                });
            }

            if (stopBtn) {
                stopBtn.addEventListener('click', async function() {
                    this.disabled = true;
                    this.textContent = '‚è≥ Deteniendo...';
                    
                    try {
                        const response = await fetch('/api/playlist/stop/', {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        const data = await response.json();
                        if (data.success) {
                            location.reload(); // Recargar para actualizar estado
                        } else {
                            alert('Error al detener la reproducci√≥n');
                            this.disabled = false;
                            this.textContent = '‚èπÔ∏è DETENER REPRODUCCI√ìN';
                        }
                    } catch (error) {
                        alert('Error de conexi√≥n');
                        this.disabled = false;
                        this.textContent = '‚èπÔ∏è DETENER REPRODUCCI√ìN';
                    }
                });
            }
        });
    </script>

    <footer>
        <p>¬© 2025 Sitio Web ADICLA Mercadotecnia y Publicidad. Todos los derechos reservados.</p>
    </footer>
</body>

</html>